---
- name: 'find default toolchains'
  tags: 'user'
  ansible.builtin.set_fact:
    rustup_default_toolchains: >-
      {{
         toolchain_config["rustup_toolchains"] |
         selectattr("default", "defined") |
         selectattr("default") |
         map(attribute = "name")
      }}

- name: 'check that exactly one toolchain is default'
  tags: 'user'
  when: 'rustup_default_toolchains | length == 0 or rustup_default_toolchains | length > 1'
  ansible.builtin.fail:
    msg: 'Configuration error: exactly one Rust toolchain must be default!'

- name: 'install rustup package'
  become: true
  become_user: 'root'
  ansible.builtin.package:
    state: 'present'
    name:
      - 'rustup'

- name: 'install rust toolchains'
  tags: 'user'
  loop: '{{ toolchain_config["rustup_toolchains"] | map(attribute = "name") }}'
  ansible.builtin.command:
    argv:
      - 'rustup'
      - 'toolchain'
      - 'install'
      - '{{ item }}'

- name: 'set default rust toolchain'
  tags: 'user'
  ansible.builtin.command:
    argv:
      - 'rustup'
      - 'default'
      - '{{ rustup_default_toolchains | first }}'

- name: 'add mandatory rust components'
  tags: 'user'
  loop:
    - 'rust-src'
    - 'rust-docs'
    - 'rust-analyzer'
  ansible.builtin.command:
    argv:
      - 'rustup'
      - 'component'
      - 'add'
      - '{{ item }}'

- name: 'add user-requsted cargo components'
  tags: 'user'
  loop: '{{ toolchain_config["cargo_plugins"] }}'
  when: '"cargo_plugins" in toolchain_config'
  ansible.builtin.command:
    argv:
      - 'cargo'
      - 'install'
      - '{{ item }}'
